<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOSI - Aquaponics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .sensor-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 5px solid #667eea;
        }

        .sensor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .sensor-card.ph { border-left-color: #FF6B6B; }
        .sensor-card.do { border-left-color: #4ECDC4; }
        .sensor-card.ec { border-left-color: #45B7D1; }
        .sensor-card.tds { border-left-color: #FFA07A; }
        .sensor-card.temp { border-left-color: #FFD93D; }

        .sensor-name {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .sensor-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .sensor-unit {
            font-size: 0.9em;
            color: #999;
        }

        .sensor-status {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-good { color: #27AE60; }
        .status-warning { color: #F39C12; }
        .status-danger { color: #E74C3C; }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-analyze {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
            min-width: 200px;
        }

        .btn-analyze:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #000;
        }

        .modal-header {
            margin-bottom: 25px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 15px;
        }

        .modal-header h2 {
            color: #333;
            margin-bottom: 5px;
        }

        .modal-header p {
            color: #666;
            font-size: 0.9em;
        }

        .concept {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }

        .concept h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .concept p {
            color: #666;
            line-height: 1.6;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 25px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Analysis Modal */
        .analysis-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .analysis-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .analysis-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .analysis-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-good {
            background: #D4EDDA;
            color: #155724;
        }

        .badge-warning {
            background: #FFF3CD;
            color: #856404;
        }

        .badge-danger {
            background: #F8D7DA;
            color: #721C24;
        }

        .recommendation {
            background: #E7F3FF;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #45B7D1;
            color: #0C5460;
            font-size: 0.9em;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 20% auto;
            }

            .controls {
                flex-direction: column;
            }

            .btn-analyze {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± TOSI Aquaponics</h1>
            <p>H·ªá th·ªëng gi√°m s√°t c·∫£m bi·∫øn th·ªùi gian th·ª±c</p>
        </div>

        <div class="controls">
            <button class="btn btn-analyze" onclick="showAnalysis()">üìä Ph√¢n T√≠ch H·ªá Th·ªëng</button>
        </div>

        <div class="dashboard">
            <div class="sensor-card ph" onclick="showSensorDetail('ph')">
                <div class="sensor-name">pH</div>
                <div class="sensor-value" id="phValue">--</div>
                <div class="sensor-unit">ƒê·ªô axit/ki·ªÅm</div>
                <div class="sensor-status" id="phStatus">--</div>
            </div>

            <div class="sensor-card do" onclick="showSensorDetail('do')">
                <div class="sensor-name">DO</div>
                <div class="sensor-value" id="doValue">--</div>
                <div class="sensor-unit">mg/L</div>
                <div class="sensor-status" id="doStatus">--</div>
            </div>

            <div class="sensor-card ec" onclick="showSensorDetail('ec')">
                <div class="sensor-name">EC</div>
                <div class="sensor-value" id="ecValue">--</div>
                <div class="sensor-unit">mS/cm</div>
                <div class="sensor-status" id="ecStatus">--</div>
            </div>

            <div class="sensor-card temp" onclick="showSensorDetail('temp')">
                <div class="sensor-name">TO</div>
                <div class="sensor-value" id="tempValue">--</div>
                <div class="sensor-unit">¬∞C</div>
                <div class="sensor-status" id="tempStatus">--</div>
            </div>

            <div class="sensor-card tds" onclick="showSensorDetail('tds')">
                <div class="sensor-name">TDS</div>
                <div class="sensor-value" id="tdsValue">--</div>
                <div class="sensor-unit">ppm</div>
                <div class="sensor-status" id="tdsStatus">--</div>
            </div>
        </div>
    </div>

    <!-- Modal Chi Ti·∫øt C·∫£m Bi·∫øn -->
    <div id="sensorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSensorModal()">&times;</span>
            <div class="modal-header">
                <h2 id="modalTitle">Chi Ti·∫øt C·∫£m Bi·∫øn</h2>
                <p id="modalSubtitle">Th√¥ng tin chi ti·∫øt v√† l·ªãch s·ª≠</p>
            </div>

            <div class="concept" id="conceptBox"></div>

            <div class="chart-container">
                <canvas id="sensorChart"></canvas>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>Th·ªùi gian</th>
                        <th>Gi√° tr·ªã</th>
                        <th>Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Ph√¢n T√≠ch -->
    <div id="analysisModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAnalysisModal()">&times;</span>
            <div class="modal-header">
                <h2>üìä Ph√¢n T√≠ch H·ªá Th·ªëng</h2>
                <p>T·ªïng quan tr·∫°ng th√°i t·∫•t c·∫£ c·∫£m bi·∫øn</p>
            </div>

            <table class="analysis-table">
                <thead>
                    <tr>
                        <th>C·∫£m Bi·∫øn</th>
                        <th>Gi√° Tr·ªã Hi·ªán T·∫°i</th>
                        <th>Tr·∫°ng Th√°i</th>
                        <th>L·ªùi Khuy√™n</th>
                    </tr>
                </thead>
                <tbody id="analysisTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- ERA Widget Script -->
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    <script>
        // Li√™n k·∫øt ph·∫ßn t·ª≠ HTML hi·ªÉn th·ªã d·ªØ li·ªáu c·∫£m bi·∫øn
        const phValue = document.getElementById('phValue');
        const doValue = document.getElementById('doValue');
        const ecValue = document.getElementById('ecValue');
        const tdsValue = document.getElementById('tdsValue');
        const tempValue = document.getElementById('tempValue');

        // Bi·∫øn l∆∞u c·∫•u h√¨nh t·ª´ng c·∫£m bi·∫øn
        let configPh = null,
            configDo = null,
            configEc = null,
            configTds = null,
            configTemp = null;

        // Bi·∫øn l∆∞u gi√° tr·ªã hi·ªán t·∫°i
        let currentValues = {
            ph: null,
            do: null,
            ec: null,
            tds: null,
            temp: null
        };

        // Bi·∫øn l∆∞u l·ªãch s·ª≠ d·ªØ li·ªáu (24 gi√° tr·ªã g·∫ßn nh·∫•t)
        let dataHistory = {
            ph: [],
            do: [],
            ec: [],
            tds: [],
            temp: []
        };

        // Kh·ªüi t·∫°o ERA Widget
        const eraWidget = new EraWidget();
        eraWidget.init({
            needRealtimeConfigs: true,
            needHistoryConfigs: false,
            needActions: false,
            maxRealtimeConfigsCount: 10,
            minRealtimeConfigsCount: 0,

            onConfiguration: (configuration) => {
                // Gi·∫£ ƒë·ªãnh th·ª© t·ª± c·∫•u h√¨nh trong ERA: 0: pH, 1: DO, 2: EC, 3: TDS, 4: Water Temp
                configPh   = configuration.realtime_configs[0];
                configDo   = configuration.realtime_configs[1];
                configEc   = configuration.realtime_configs[2];
                configTds  = configuration.realtime_configs[3];
                configTemp = configuration.realtime_configs[4];

                console.log('C·∫•u h√¨nh c·∫£m bi·∫øn nh·∫≠n ƒë∆∞·ª£c:', configuration.realtime_configs);
            },

            onValues: (values) => {
                // C·∫≠p nh·∫≠t gi√° tr·ªã hi·ªán t·∫°i
                if (configPh && values[configPh.id]) {
                    const phVal = values[configPh.id].value.toFixed(2);
                    phValue.innerHTML = phVal;
                    currentValues.ph = parseFloat(phVal);
                    updateStatus('ph', phVal);
                    addToHistory('ph', phVal);
                }
                if (configDo && values[configDo.id]) {
                    const doVal = values[configDo.id].value.toFixed(2);
                    doValue.innerHTML = doVal;
                    currentValues.do = parseFloat(doVal);
                    updateStatus('do', doVal);
                    addToHistory('do', doVal);
                }
                if (configEc && values[configEc.id]) {
                    const ecVal = values[configEc.id].value.toFixed(2);
                    ecValue.innerHTML = ecVal;
                    currentValues.ec = parseFloat(ecVal);
                    updateStatus('ec', ecVal);
                    addToHistory('ec', ecVal);
                }
                if (configTds && values[configTds.id]) {
                    const tdsVal = values[configTds.id].value.toFixed(2);
                    tdsValue.innerHTML = tdsVal;
                    currentValues.tds = parseFloat(tdsVal);
                    updateStatus('tds', tdsVal);
                    addToHistory('tds', tdsVal);
                }
                if (configTemp && values[configTemp.id]) {
                    const tempVal = values[configTemp.id].value.toFixed(2);
                    tempValue.innerHTML = tempVal;
                    currentValues.temp = parseFloat(tempVal);
                    updateStatus('temp', tempVal);
                    addToHistory('temp', tempVal);
                }

                console.log('Gi√° tr·ªã c·∫≠p nh·∫≠t t·ª´ ERA:', values);
            },
        });

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i
        function updateStatus(sensor, value) {
            const val = parseFloat(value);
            let status = '';
            let statusClass = '';

            switch(sensor) {
                case 'ph':
                    if (val >= 6.5 && val <= 7.5) {
                        status = '‚úì T·ªët';
                        statusClass = 'status-good';
                    } else if (val >= 6 && val <= 8) {
                        status = '‚ö† C·∫£nh b√°o';
                        statusClass = 'status-warning';
                    } else {
                        status = '‚úó Nguy hi·ªÉm';
                        statusClass = 'status-danger';
                    }
                    break;
                case 'do':
                    if (val >= 5) {
                        status = '‚úì T·ªët';
                        statusClass = 'status-good';
                    } else if (val >= 3) {
                        status = '‚ö† C·∫£nh b√°o';
                        statusClass = 'status-warning';
                    } else {
                        status = '‚úó Nguy hi·ªÉm';
                        statusClass = 'status-danger';
                    }
                    break;
                case 'ec':
                    if (val >= 1.2 && val <= 2.0) {
                        status = '‚úì T·ªët';
                        statusClass = 'status-good';
                    } else if (val >= 0.8 && val <= 2.5) {
                        status = '‚ö† C·∫£nh b√°o';
                        statusClass = 'status-warning';
                    } else {
                        status = '‚úó Nguy hi·ªÉm';
                        statusClass = 'status-danger';
                    }
                    break;
                case 'tds':
                    if (val >= 600 && val <= 1200) {
                        status = '‚úì T·ªët';
                        statusClass = 'status-good';
                    } else if (val >= 400 && val <= 1500) {
                        status = '‚ö† C·∫£nh b√°o';
                        statusClass = 'status-warning';
                    } else {
                        status = '‚úó Nguy hi·ªÉm';
                        statusClass = 'status-danger';
                    }
                    break;
                case 'temp':
                    if (val >= 25 && val <= 30) {
                        status = '‚úì T·ªët';
                        statusClass = 'status-good';
                    } else if (val >= 20 && val <= 35) {
                        status = '‚ö† C·∫£nh b√°o';
                        statusClass = 'status-warning';
                    } else {
                        status = '‚úó Nguy hi·ªÉm';
                        statusClass = 'status-danger';
                    }
                    break;
            }

            const statusEl = document.getElementById(sensor + 'Status');
            if (statusEl) {
                statusEl.innerHTML = status;
                statusEl.className = 'sensor-status ' + statusClass;
            }
        }

        // H√†m th√™m v√†o l·ªãch s·ª≠
        function addToHistory(sensor, value) {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                           now.getMinutes().toString().padStart(2, '0');
            
            dataHistory[sensor].push({
                time: timeStr,
                value: parseFloat(value)
            });

            // Gi·ªØ t·ªëi ƒëa 24 gi√° tr·ªã
            if (dataHistory[sensor].length > 24) {
                dataHistory[sensor].shift();
            }
        }

        // Kh√°i ni·ªám c·∫£m bi·∫øn
        const concepts = {
            ph: {
                title: 'pH - ƒê·ªô Axit/Ki·ªÅm',
                description: 'pH ƒëo ƒë·ªô axit ho·∫∑c ki·ªÅm c·ªßa n∆∞·ªõc. Trong aquaponics, pH l√Ω t∆∞·ªüng l√† 6.8-7.0 ƒë·ªÉ c√¢n b·∫±ng gi·ªØa c√° v√† c√¢y. N·∫øu pH qu√° th·∫•p (axit), c√° s·∫Ω b·ªã stress. N·∫øu qu√° cao (ki·ªÅm), c√°c ch·∫•t dinh d∆∞·ª°ng s·∫Ω kh√¥ng ƒë∆∞·ª£c h·∫•p th·ª• t·ªët.'
            },
            do: {
                title: 'DO - Oxy H√≤a Tan',
                description: 'DO (Dissolved Oxygen) l√† l∆∞·ª£ng oxy h√≤a tan trong n∆∞·ªõc. C√° c·∫ßn oxy ƒë·ªÉ s·ªëng, th∆∞·ªùng c·∫ßn t·ª´ 5-8 mg/L. N·∫øu DO qu√° th·∫•p, c√° s·∫Ω b·ªã ng·∫°t v√† c√≥ th·ªÉ ch·∫øt. C·∫ßn s·ª≠ d·ª•ng m√°y s·ª•c kh√≠ ƒë·ªÉ tƒÉng DO.'
            },
            ec: {
                title: 'EC - ƒê·ªô D·∫´n ƒêi·ªán',
                description: 'EC (Electrical Conductivity) ƒëo n·ªìng ƒë·ªô mu·ªëi/ch·∫•t dinh d∆∞·ª°ng trong n∆∞·ªõc. Trong aquaponics, EC l√Ω t∆∞·ªüng l√† 1.2-2.0 mS/cm. EC qu√° cao c√≥ th·ªÉ g√¢y ƒë·ªôc cho c√° v√† c√¢y, qu√° th·∫•p th√¨ c√¢y s·∫Ω thi·∫øu dinh d∆∞·ª°ng.'
            },
            tds: {
                title: 'TDS - T·ªïng Ch·∫•t R·∫Øn H√≤a Tan',
                description: 'TDS (Total Dissolved Solids) l√† t·ªïng l∆∞·ª£ng ch·∫•t r·∫Øn h√≤a tan trong n∆∞·ªõc, th∆∞·ªùng t√≠nh b·∫±ng ppm. Trong aquaponics, TDS l√Ω t∆∞·ªüng l√† 600-1200 ppm. TDS cao qu√° c√≥ th·ªÉ g√¢y ƒë·ªôc, th·∫•p qu√° th√¨ thi·∫øu dinh d∆∞·ª°ng.'
            },
            temp: {
                title: 'TO - Nhi·ªát ƒê·ªô N∆∞·ªõc',
                description: 'Nhi·ªát ƒë·ªô n∆∞·ªõc ·∫£nh h∆∞·ªüng ƒë·∫øn t·ªëc ƒë·ªô trao ƒë·ªïi ch·∫•t c·ªßa c√° v√† c√¢y. Nhi·ªát ƒë·ªô l√Ω t∆∞·ªüng l√† 25-30¬∞C. N·∫øu qu√° l·∫°nh, c√° s·∫Ω ƒÉn √≠t v√† tƒÉng tr∆∞·ªüng ch·∫≠m. N·∫øu qu√° n√≥ng, DO s·∫Ω gi·∫£m v√† c√° s·∫Ω b·ªã stress.'
            }
        };

        // H√†m hi·ªÉn th·ªã chi ti·∫øt c·∫£m bi·∫øn
        function showSensorDetail(sensor) {
            const modal = document.getElementById('sensorModal');
            const title = document.getElementById('modalTitle');
            const subtitle = document.getElementById('modalSubtitle');
            const conceptBox = document.getElementById('conceptBox');
            const dataTableBody = document.getElementById('dataTableBody');

            title.textContent = concepts[sensor].title;
            subtitle.textContent = 'Gi√° tr·ªã hi·ªán t·∫°i: ' + (currentValues[sensor] || '--');

            conceptBox.innerHTML = `
                <h3>${concepts[sensor].title}</h3>
                <p>${concepts[sensor].description}</p>
            `;

            // Hi·ªÉn th·ªã b·∫£ng d·ªØ li·ªáu
            dataTableBody.innerHTML = '';
            dataHistory[sensor].forEach((item, index) => {
                const row = document.createElement('tr');
                let status = '';
                
                if (sensor === 'ph') {
                    status = (item.value >= 6.5 && item.value <= 7.5) ? '‚úì T·ªët' : 
                             (item.value >= 6 && item.value <= 8) ? '‚ö† C·∫£nh b√°o' : '‚úó Nguy hi·ªÉm';
                } else if (sensor === 'do') {
                    status = (item.value >= 5) ? '‚úì T·ªët' : 
                             (item.value >= 3) ? '‚ö† C·∫£nh b√°o' : '‚úó Nguy hi·ªÉm';
                } else if (sensor === 'ec') {
                    status = (item.value >= 1.2 && item.value <= 2.0) ? '‚úì T·ªët' : 
                             (item.value >= 0.8 && item.value <= 2.5) ? '‚ö† C·∫£nh b√°o' : '‚úó Nguy hi·ªÉm';
                } else if (sensor === 'tds') {
                    status = (item.value >= 600 && item.value <= 1200) ? '‚úì T·ªët' : 
                             (item.value >= 400 && item.value <= 1500) ? '‚ö† C·∫£nh b√°o' : '‚úó Nguy hi·ªÉm';
                } else if (sensor === 'temp') {
                    status = (item.value >= 25 && item.value <= 30) ? '‚úì T·ªët' : 
                             (item.value >= 20 && item.value <= 35) ? '‚ö† C·∫£nh b√°o' : '‚úó Nguy hi·ªÉm';
                }

                row.innerHTML = `
                    <td>${item.time}</td>
                    <td>${item.value.toFixed(2)}</td>
                    <td>${status}</td>
                `;
                dataTableBody.appendChild(row);
            });

            // V·∫Ω bi·ªÉu ƒë·ªì
            drawChart(sensor);

            modal.style.display = 'block';
        }

        // H√†m v·∫Ω bi·ªÉu ƒë·ªì
        let chart = null;
        function drawChart(sensor) {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            const labels = dataHistory[sensor].map(item => item.time);
            const data = dataHistory[sensor].map(item => item.value);

            let minValue = 0, maxValue = 10;
            if (sensor === 'ph') { minValue = 5; maxValue = 9; }
            else if (sensor === 'do') { minValue = 0; maxValue = 12; }
            else if (sensor === 'ec') { minValue = 0; maxValue = 3; }
            else if (sensor === 'tds') { minValue = 0; maxValue = 2000; }
            else if (sensor === 'temp') { minValue = 15; maxValue = 40; }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: concepts[sensor].title,
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: { size: 12 }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: minValue,
                            max: maxValue
                        }
                    }
                }
            });
        }

        // H√†m hi·ªÉn th·ªã ph√¢n t√≠ch
        function showAnalysis() {
            const modal = document.getElementById('analysisModal');
            const tableBody = document.getElementById('analysisTableBody');

            tableBody.innerHTML = '';

            const sensors = [
                { key: 'ph', name: 'pH', unit: '' },
                { key: 'do', name: 'DO', unit: 'mg/L' },
                { key: 'ec', name: 'EC', unit: 'mS/cm' },
                { key: 'tds', name: 'TDS', unit: 'ppm' },
                { key: 'temp', name: 'TO', unit: '¬∞C' }
            ];

            sensors.forEach(sensor => {
                const value = currentValues[sensor.key];
                if (value === null) return;

                let status = '';
                let statusBadge = '';
                let recommendation = '';

                if (sensor.key === 'ph') {
                    if (value >= 6.5 && value <= 7.5) {
                        status = 'T·ªët';
                        statusBadge = 'badge-good';
                        recommendation = 'Duy tr√¨ pH hi·ªán t·∫°i. Ki·ªÉm tra ƒë·ªãnh k·ª≥ h√†ng ng√†y.';
                    } else if (value >= 6 && value <= 8) {
                        status = 'C·∫£nh b√°o';
                        statusBadge = 'badge-warning';
                        recommendation = 'pH h∆°i l·ªách. ƒêi·ªÅu ch·ªânh b·∫±ng c√°ch th√™m acid ho·∫∑c base t·ª´ t·ª´.';
                    } else {
                        status = 'Nguy hi·ªÉm';
                        statusBadge = 'badge-danger';
                        recommendation = 'pH qu√° cao ho·∫∑c qu√° th·∫•p. C·∫ßn ƒëi·ªÅu ch·ªânh ngay l·∫≠p t·ª©c.';
                    }
                } else if (sensor.key === 'do') {
                    if (value >= 5) {
                        status = 'T·ªët';
                        statusBadge = 'badge-good';
                        recommendation = 'DO ƒë·ªß cho c√°. Ti·∫øp t·ª•c s·ª•c kh√≠ b√¨nh th∆∞·ªùng.';
                    } else if (value >= 3) {
                        status = 'C·∫£nh b√°o';
                        statusBadge = 'badge-warning';
                        recommendation = 'DO th·∫•p. TƒÉng t·ªëc ƒë·ªô s·ª•c kh√≠ ho·∫∑c ki·ªÉm tra m√°y s·ª•c.';
                    } else {
                        status = 'Nguy hi·ªÉm';
                        statusBadge = 'badge-danger';
                        recommendation = 'DO r·∫•t th·∫•p. C√° c√≥ th·ªÉ b·ªã ng·∫°t. TƒÉng s·ª•c kh√≠ ngay.';
                    }
                } else if (sensor.key === 'ec') {
                    if (value >= 1.2 && value <= 2.0) {
                        status = 'T·ªët';
                        statusBadge = 'badge-good';
                        recommendation = 'EC l√Ω t∆∞·ªüng. Duy tr√¨ m·ª©c hi·ªán t·∫°i.';
                    } else if (value >= 0.8 && value <= 2.5) {
                        status = 'C·∫£nh b√°o';
                        statusBadge = 'badge-warning';
                        recommendation = 'EC h∆°i l·ªách. Thay n∆∞·ªõc m·ªôt ph·∫ßn ho·∫∑c th√™m dinh d∆∞·ª°ng.';
                    } else {
                        status = 'Nguy hi·ªÉm';
                        statusBadge = 'badge-danger';
                        recommendation = 'EC qu√° cao ho·∫∑c qu√° th·∫•p. C·∫ßn ƒëi·ªÅu ch·ªânh ngay.';
                    }
                } else if (sensor.key === 'tds') {
                    if (value >= 600 && value <= 1200) {
                        status = 'T·ªët';
                        statusBadge = 'badge-good';
                        recommendation = 'TDS l√Ω t∆∞·ªüng. Duy tr√¨ m·ª©c hi·ªán t·∫°i.';
                    } else if (value >= 400 && value <= 1500) {
                        status = 'C·∫£nh b√°o';
                        statusBadge = 'badge-warning';
                        recommendation = 'TDS h∆°i l·ªách. Thay n∆∞·ªõc m·ªôt ph·∫ßn ƒë·ªÉ c√¢n b·∫±ng.';
                    } else {
                        status = 'Nguy hi·ªÉm';
                        statusBadge = 'badge-danger';
                        recommendation = 'TDS qu√° cao ho·∫∑c qu√° th·∫•p. C·∫ßn ƒëi·ªÅu ch·ªânh ngay.';
                    }
                } else if (sensor.key === 'temp') {
                    if (value >= 25 && value <= 30) {
                        status = 'T·ªët';
                        statusBadge = 'badge-good';
                        recommendation = 'Nhi·ªát ƒë·ªô l√Ω t∆∞·ªüng. Duy tr√¨ m·ª©c hi·ªán t·∫°i.';
                    } else if (value >= 20 && value <= 35) {
                        status = 'C·∫£nh b√°o';
                        statusBadge = 'badge-warning';
                        recommendation = 'Nhi·ªát ƒë·ªô h∆°i l·ªách. Ki·ªÉm tra h·ªá th·ªëng l√†m m√°t/s∆∞·ªüi.';
                    } else {
                        status = 'Nguy hi·ªÉm';
                        statusBadge = 'badge-danger';
                        recommendation = 'Nhi·ªát ƒë·ªô qu√° cao ho·∫∑c qu√° th·∫•p. C·∫ßn ƒëi·ªÅu ch·ªânh ngay.';
                    }
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${sensor.name}</strong></td>
                    <td>${value.toFixed(2)} ${sensor.unit}</td>
                    <td><span class="status-badge ${statusBadge}">${status}</span></td>
                    <td><div class="recommendation">${recommendation}</div></td>
                `;
                tableBody.appendChild(row);
            });

            modal.style.display = 'block';
        }

        // H√†m ƒë√≥ng modal
        function closeSensorModal() {
            document.getElementById('sensorModal').style.display = 'none';
        }

        function closeAnalysisModal() {
            document.getElementById('analysisModal').style.display = 'none';
        }

        // ƒê√≥ng modal khi click ngo√†i
        window.onclick = function(event) {
            const sensorModal = document.getElementById('sensorModal');
            const analysisModal = document.getElementById('analysisModal');
            
            if (event.target === sensorModal) {
                sensorModal.style.display = 'none';
            }
            if (event.target === analysisModal) {
                analysisModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
